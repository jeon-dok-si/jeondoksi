# Business Logic Specification

## 1. 독후감 분석 및 검증 로직 (ReportService)

독후감 제출 시 다음과 같은 단계로 검증 및 분석이 이루어집니다.

### 1.1. 전처리 및 유효성 검사 (Step 0)
- **최소 길이**: 공백 제외 50자 이상이어야 합니다.
- **반복 문자**: 동일 문자가 10회 이상 반복되면 차단합니다. (스팸 방지)

### 1.2. AI 생성 여부 탐지 (Step 1)
- **OpenAI API 활용**: 작성된 내용을 GPT 모델에 보내 AI가 작성했을 확률을 분석합니다.
- **차단 기준**: AI 작성 확률이 **90% 이상**일 경우 `AI_GENERATED_CONTENT_DETECTED` 예외를 발생시킵니다.
- **Fallback**: 외부 API 호출 실패 시, 사용자 경험을 위해 일단 통과시킵니다.

### 1.3. 앙상블 적대적 검증 (Step 2)
- **AI 샘플 비교**: 사전에 생성된 'AI가 쓴 독후감 샘플'들과 코사인 유사도를 비교합니다. 유사도가 **0.85 이상**이면 차단합니다.
- **책 줄거리 비교**:
    - **표절 검사**: 책 줄거리와 유사도가 **0.85 이상**이면 베낀 것으로 간주하여 차단합니다.
    - **무관 검사**: 책 줄거리와 유사도가 **0.02 미만**이면 책과 전혀 관련 없는 내용으로 간주하여 차단합니다.
- **자가 복제 검사**: 사용자의 최근 독후감 3건과 비교하여 유사도가 **0.85 이상**이면 중복 제출로 간주하여 차단합니다.

### 1.4. NLP 성향 분석 (Komoran)
- **형태소 분석**: Komoran 형태소 분석기를 사용하여 명사, 동사, 형용사를 추출합니다.
- **성향 점수 산출**:
    - **Logic (논리)**: '분석', '이유', '생각', '구조' 등의 키워드 빈도
    - **Emotion (감성)**: '슬픔', '기쁨', '감동', '눈물' 등의 키워드 빈도
    - **Action (행동)**: '실천', '도전', '변화', '노력' 등의 키워드 빈도
- **결과 저장**: 분석된 점수(Logic, Emotion, Action)와 성향 타입(ANALYST, EMPATH 등)을 DB에 저장하고, 사용자 스탯에 누적합니다.
- **보상**: 검증 및 분석이 완료되면 사용자에게 **50 XP**를 지급합니다.

---

## 2. 퀴즈 생성 및 채점 로직 (QuizService)

### 2.1. 퀴즈 생성 (GPT-4o)
- **프롬프트 구성**:
    - **책 정보**: 제목, 줄거리 (Naver API)
    - **사용자 정보**: 사용자가 작성한 독후감 내용 (개인화)
    - **제약 사항**:
        - 난이도 '하' (누구나 풀 수 있게)
        - 외적 정보(작가 사생활, 출판일 등) 금지
        - 책의 내용(줄거리, 인물, 사건)에 집중
        - 사용자 독후감 내용을 반영한 문제 1~2개 포함 (단답형 제외)
- **문제 구성**: 총 5문제
    - 1~2번: 객관식 (5지선다)
    - 3~4번: OX 퀴즈
    - 5번: 단답형 (주관식)

### 2.2. 퀴즈 채점
- **객관식 / OX**: 정답과 완전히 일치해야 정답 (100점)
- **단답형 (유사도 채점)**:
    - **전처리**: 띄어쓰기 제거, 특수문자 제거, 소문자 변환
    - **포함 관계**: 정답이 답안에 포함되거나, 답안이 정답에 포함되면 정답 인정 (100점)
    - **유사도 (Levenshtein Distance)**:
        - 유사도 80% 이상: 정답 (100점)
        - 유사도 60% 이상: 부분 점수 (70점)
        - 유사도 40% 이상: 부분 점수 (30점)
- **통과 기준**: 총점 60점 이상 시 `PASS` 처리됩니다.
- **보상**: 최초 통과 시 **100 XP**와 **100 Point**를 지급합니다. (중복 수령 불가)

---

## 3. 도서 추천 알고리즘 (RecommendationService)

### 3.1. TF-IDF 기반 유사도 분석
- **사용자 프로필**: 사용자가 읽은 책들의 키워드를 통합하여 하나의 문서로 취급합니다.
- **도서 프로필**: 추천 후보군 책들의 키워드를 각각의 문서로 취급합니다.
- **TF-IDF 계산**: 전체 문서 집합에서 각 키워드의 중요도를 계산하여 벡터화합니다.
- **코사인 유사도**: 사용자 벡터와 도서 벡터 간의 각도를 계산하여 유사한 책을 찾습니다.

### 3.2. 사용자 성향 가중치 (Personality Weighting)
- 사용자의 주된 성향(Logic, Emotion, Action)을 파악합니다.
- 추천 후보 도서의 키워드에 해당 성향과 관련된 단어가 포함되어 있으면 가중치(1.2배)를 부여합니다.
    - 예: '논리' 성향 사용자에겐 '철학', '과학' 키워드가 있는 책 점수 상향

### 3.3. 추천 리스트 생성
- **신규 사용자**: 독후감 기록이 없으면 베스트셀러 중 랜덤 3권을 추천합니다.
- **기존 사용자**:
    1. 읽은 책 제외
    2. TF-IDF + 성향 가중치 점수 계산
    3. 상위 10권 추출
    4. 상위 10권 중 **랜덤 3권** 선택 (매번 다른 추천을 보여주기 위함)

---

## 4. 게임화 및 아이템 (RewardService)

### 4.1. 아이템 뽑기 (Gacha)
- **비용**: 1 회당 **100 Point** 소모
- **확률**:
    - **COMMON (일반)**: 60%
    - **RARE (희귀)**: 30%
    - **EPIC (전설)**: 10%
- **중복**: 중복 획득 가능 (현재 로직상 중복 시 인벤토리에 쌓임)

### 4.2. 아이템 장착
- 아이템은 `HEAD`, `FACE`, `BODY` 등의 카테고리를 가집니다.
- 같은 카테고리의 아이템은 하나만 장착 가능합니다.
- 새로운 아이템 장착 시, 기존에 장착된 같은 카테고리 아이템은 자동으로 해제됩니다.
